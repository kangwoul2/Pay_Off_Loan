# 개발 일지 (Development Log)

## 프로젝트 개요
- **프로젝트명**: 대환대출 시뮬레이터
- **목적**: 사회초년생의 다중 채무 해결 및 대환대출 의사결정 지원
- **기간**: 2026.02.11 ~ 2026.02.13

---

## 2026.02.11 (수)

### 1단계: 문제 정의 및 페르소나 설정 ✅

#### 핵심 타겟 페르소나
- **메인 페르소나 'A'**: 20대 후반 1~3년차 사회초년생
  - 신용도 개선으로 대출 전환 기회 多
  - 평균 2~3개의 대출 보유 (학자금, 신용대출, 전세자금)
  
- **확장 페르소나**: 40대 이직자, 정년퇴직자

#### 핵심 페인포인트
> "중도상환 수수료를 내면서까지 대환대출을 받는 것이 정말 이득인가?"

#### 서비스 핵심 가치
1. 실질 이득 시뮬레이션 (중도상환 수수료 + 인지세 vs 이자 절감액)
2. 명확한 액션 가이드 (즉시 대환 / 수수료 면제 대기 / 현재 유지)
3. 시각적 비교 (전략 실행 전/후 차트)

---

### 2단계: 기술 스택 및 아키텍처 설계 ✅

#### 기술 스택 선정
- **Frontend**: Next.js 14 + Tailwind CSS + Recharts
- **Backend**: Next.js API Routes + Supabase
- **Crawling**: Python 3.10+ (BeautifulSoup/Selenium)
- **금융 계산**: big.js (정밀도 확보)

#### 핵심 아키텍처 결정사항

##### 1) 정밀도 확보
- **문제**: JavaScript number 타입의 부동소수점 오차
- **해결**: big.js 라이브러리로 모든 금융 계산 처리
- **근거**: 금융 데이터는 DECIMAL(15,4) 수준의 정밀도 필요

##### 2) 상환 방식 확장성
- **해결**: Strategy Pattern 적용
- **구현**: RepaymentStrategy 인터페이스 + 원리금균등/원금균등 클래스
- **근거**: 향후 만기일시, 거치식 등 추가 방식 확장 용이

##### 3) 중도상환 수수료 로직 구체화
- **로직**:
  - 기본 수수료 = 잔여원금 × 수수료율(%)
  - 시간 비례 감면 = (잔여개월 / 전체개월) × 기본 수수료
  - 수수료 면제 기간(보통 3년) 경과 시 수수료 0원

##### 4) 인지세 정책 상수화
- **정책** (2026년 기준):
  - 5천만원 이하: 면제
  - 5천만원 초과 ~ 1억원: 7만원
  - 1억원 초과 ~ 10억원: 15만원
  - 10억원 초과: 35만원
- **구현**: FinanceConfig 클래스로 중앙 관리

##### 5) 금리 정보 현실화
- **구조**: [기본 금리 + 가산 금리] + 급여이체 우대
- **근거**: 모든 우대 조건 크롤링 불가, 사용자 직접 입력 가능하게

##### 6) 데이터 정합성
- **해결**: CHECK 제약조건 (금리 0~30%, 한도 > 0 등)
- **근거**: DB 레벨에서 1차 검증으로 잘못된 데이터 유입 방지

---

### 3단계: 크롤링 파이프라인 설계 및 구현 ✅

#### 프로젝트 구조 생성
```
loan-refinance-simulator/
├── crawling/
│   ├── __init__.py
│   ├── config.py              # 크롤링 설정
│   ├── cleansing.py           # 데이터 전처리
│   ├── crawler.py             # 베이스 크롤러
│   ├── supabase_client.py     # DB 연동
│   ├── main.py                # 실행 파일
│   └── bank_crawlers/
│       ├── __init__.py
│       └── kb_crawler.py      # KB국민은행 (완료)
├── docs/
│   └── development_log.md     # 본 파일
├── .env.example
├── .gitignore
├── requirements.txt
├── database_schema.sql
└── README.md
```

#### 구현 완료 항목
- [x] BaseBankCrawler 추상 클래스 설계
- [x] LoanDataCleaner 전처리 클래스 구현
- [x] SupabaseManager DB 연동 클래스
- [x] KB 크롤러 구현 (더미 데이터 포함)
- [x] 크롤링 설정 및 상수 관리
- [x] Supabase 데이터베이스 스키마 작성

#### 데이터 전처리 파이프라인
1. **크롤링**: Selenium/BeautifulSoup로 HTML 파싱
2. **전처리 (Cleansing)**:
   - 결측치 처리
   - 텍스트 → 숫자 변환 (정규식)
   - 이상치 검증 (금리 범위 체크)
   - 중복 제거 (은행명 + 상품명)
3. **적재**: Supabase UPSERT (중복 시 업데이트)

#### 로깅 전략
- 크롤링 성공/실패 로그 DB 기록
- 파일 로그 생성 (crawling_YYYYMMDD_HHMMSS.log)
- 에러 핸들링 및 재시도 로직

---

### 4단계: 대출 계산 알고리즘 구현 ✅

#### 구현 완료 항목
- [x] Strategy Pattern 기반 상환 계산 엔진
- [x] 원리금균등 / 원금균등 상환 방식 구현
- [x] 중도상환 수수료 계산 (시간 비례 감면 포함)
- [x] 손익분기점(BEP) 분석 알고리즘
- [x] 대환대출 시뮬레이션 서비스
- [x] 입력값 검증 유틸리티
- [x] Next.js API 엔드포인트 (`/api/simulate`)
- [x] 엣지 케이스 분석 및 처리

#### 핵심 금융 수식 및 근거

##### 1) 원리금균등 상환
```
월 상환액 = P × [r × (1+r)^n] / [(1+r)^n - 1]
```
- **금융적 근거**: 현재 가치의 합 = 미래 가치의 합 (등비급수 공식)
- **특징**: 매월 동일 금액 상환, 초반 이자 비중 ↑
- **장점**: 상환 계획 수립 용이, 현금 흐름 관리 편리
- **단점**: 총 이자 부담이 원금균등보다 높음

##### 2) 원금균등 상환
```
월 원금 상환액 = P / n
매월 이자 = 잔여원금 × 월 이자율
```
- **금융적 근거**: 원금을 균등 분할, 이자는 잔액 기준 계산
- **특징**: 매월 상환액 감소, 초반 부담 ↑
- **장점**: 총 이자 부담 적음
- **단점**: 초기 상환 부담이 커서 소득 안정성 필요

##### 3) 중도상환 수수료
```
기본 수수료 = 잔여원금 × 수수료율(%)
시간 비례 감면 = 기본 수수료 × (잔여개월 / 전체개월)
```
- **금융적 근거**: 
  - 은행은 대출 시 향후 이자 수익을 기대
  - 중도상환 시 예상 수익 감소를 보전하기 위해 수수료 부과
  - 시간 경과에 따라 이미 회수한 이자가 증가하므로 수수료 감면
- **특징**: 수수료 면제 기간(보통 3년) 경과 시 0원

##### 4) 손익분기점(BEP)
```
BEP(개월) = (중도상환 수수료 + 인지세) / 월별 절감액
```
- **금융적 근거**: 대환 비용을 월별 절감액으로 회수하는 데 걸리는 시간
- **특징**: BEP가 짧을수록 빨리 이득을 볼 수 있음
- **의사결정 기준**:
  - BEP < 잔여 기간: 대환 추천
  - BEP > 잔여 기간: 현재 유지 추천

##### 5) 인지세 정책
- 법적 근거: 인지세법 시행령 제3조 (2026년 기준)
- 5천만원 이하: 면제
- 5천만원 초과 ~ 1억원: 7만원
- 1억원 초과 ~ 10억원: 15만원
- 10억원 초과: 35만원

#### 엣지 케이스 및 오류 가능성 분석

**총 10가지 주요 문제점 발견 및 처리:**

##### 🔴 High Priority (필수 처리 완료)

1. **잔여 기간 0 또는 음수**
   - 문제: `principal.div(0)` 오류 발생 가능
   - 해결: 입력값 검증 단계에서 차단
   ```typescript
   if (remainingMonths <= 0) {
     throw new Error('잔여 상환 기간은 1개월 이상이어야 합니다.');
   }
   ```

2. **금리 음수**
   - 문제: 우대금리 합산 시 음수 가능
   - 해결: 신규 금리 계산 시 0% 하한선 설정
   ```typescript
   if (newRate.lt(0)) {
     newRate = Big(0);
   }
   ```

3. **잔여 기간 > 전체 기간**
   - 문제: 중도상환 수수료 계산 시 `elapsedMonths < 0`
   - 해결: 입력값 검증 단계에서 차단
   ```typescript
   if (remainingMonths > totalMonths) {
     throw new Error('잔여 기간이 전체 기간보다 클 수 없습니다.');
   }
   ```

##### 🟡 Medium Priority (향후 개선 필요)

4. **BEP가 잔여 기간보다 긴 경우**
   - 현재: "현재_유지"로 분류
   - 개선 필요: 사용자에게 이유 설명
   - 제안: `reason` 필드 추가

5. **수수료 면제 대기 로직 개선**
   - 현재: 3개월 이하 남은 경우만 대기 권장
   - 개선 필요: 실제 순이익 계산하여 비교
   - 제안: `calculateSavingsIfWait()` 함수 추가

6. **큰 금액 오버플로우**
   - 현재: Big.js 사용으로 안전
   - 개선 필요: 5억원 초과 시 경고 표시

##### 🟢 Low Priority (선택 개선)

7. **여러 상품 추천 시 가중치 부족**
   - 현재: 순이익만 고려
   - 개선 제안: 가중치 점수 시스템
     - 순이익 40% + BEP 30% + 월별 절감액 20% + 신뢰도 10%

8. **오류 메시지 사용자 친화성**
   - 현재: 기술적 메시지
   - 개선: "금리는 0%~30% 사이로 입력해주세요."

9. **성능 최적화**
   - 현재: 매번 전체 스케줄 생성
   - 개선: Lazy evaluation

10. **NULL 처리**
    - 현재: DB DEFAULT 값
    - 개선: API 명시적 NULL 체크

#### 구현 파일 구조
```
src/
├── lib/
│   ├── config/
│   │   └── finance-config.ts          # 금융 상수 관리
│   ├── strategies/
│   │   └── repayment-strategy.ts      # Strategy Pattern
│   ├── services/
│   │   └── simulation-service.ts      # 시뮬레이션 엔진
│   └── utils/
│       ├── validation.ts              # 입력값 검증
│       └── test-examples.ts           # 테스트 시나리오
└── app/
    └── api/
        └── simulate/
            └── route.ts               # API 엔드포인트
```

#### API 엔드포인트

**POST /api/simulate**
```json
{
  "currentDebt": {
    "principal": 50000000,
    "interestRate": 5.5,
    "remainingMonths": 36,
    "totalMonths": 60,
    "repaymentType": "원리금균등",
    "earlyRepayFeeRate": 1.5,
    "feeWaiverMonths": 36
  },
  "loanProducts": [
    {
      "bankName": "KB",
      "productName": "KB직장인신용대출",
      "baseRate": 3.5,
      "additionalRate": 1.7,
      "salaryTransferDiscount": 0.3,
      "userOtherDiscount": 0.0
    }
  ],
  "hasSalaryTransfer": true,
  "mode": "best"
}
```

#### 테스트 시나리오

6가지 주요 시나리오 작성 완료:
1. 일반적인 대환대출 (즉시 이득)
2. 손해 보는 경우 (금리 상승)
3. 수수료 면제 대기 권장
4. 여러 상품 중 최적 선택
5. 엣지 케이스 - 무이자 대출
6. 원금균등 vs 원리금균등 비교

#### AI 도구 활용 기록

**1. 금융 수식 검증**
- AI에게 "원리금균등 상환 공식의 수학적 유도 과정" 요청
- 결과: 등비급수 공식에서 유도되는 과정 확인
- 검증: 기존 금융 교과서 및 은행 공식과 일치 확인

**2. 엣지 케이스 발견**
- AI에게 "이 코드에서 발생 가능한 모든 오류 상황" 분석 요청
- 결과: 10가지 주요 문제점 발견
- 조치: High Priority 3개 즉시 수정, 나머지는 문서화

**3. 코드 리뷰 및 개선**
- AI에게 "중도상환 수수료 계산 로직 검토" 요청
- 발견: 시간 비례 감면 로직이 실제 은행 정책과 일치
- 개선: 주석에 금융적 근거 상세 추가

---

## 다음 단계 (TODO)

### 5단계: Next.js 프론트엔드 구축
- [ ] Strategy Pattern 기반 상환 계산 엔진
- [ ] 중도상환 수수료 계산 로직
- [ ] 손익분기점(BEP) 분석 알고리즘
- [ ] 시뮬레이션 API 엔드포인트

### 5단계: Next.js 프론트엔드 구축
- [ ] 사용자 대출 정보 입력 폼
- [ ] 시뮬레이션 결과 대시보드
- [ ] Recharts 기반 시각화
- [ ] 반응형 UI (Tailwind CSS)

### 6단계: Vercel 배포
- [ ] 환경 변수 설정
- [ ] 빌드 최적화
- [ ] Early Deploy 및 피드백
- [ ] 도메인 연결

### 7단계: 문서화 및 제출
- [ ] README 최종 업데이트
- [ ] 기획서 작성
- [ ] 과제 제출

---

## 기술적 도전 과제 및 해결 방법

### 도전 1: JavaScript 부동소수점 오차
- **문제**: 금융 계산에서 소수점 오차 발생
- **해결**: big.js 라이브러리 사용
- **결과**: DECIMAL(15,4) 수준 정밀도 확보

### 도전 2: 은행 사이트 크롤링 난이도
- **문제**: 각 은행마다 다른 HTML 구조, 동적 렌더링
- **해결**: 
  - Selenium으로 동적 페이지 처리
  - 은행별 크롤러 개별 구현
  - 실패 시 더미 데이터 사용 (테스트용)
- **향후 개선**: robots.txt 확인, 크롤링 빈도 제한

### 도전 3: 데이터 정합성 확보
- **문제**: 크롤링 데이터의 신뢰도 문제
- **해결**:
  - 전처리 단계에서 검증 (금리 범위, 한도 등)
  - DB CHECK 제약조건 설정
  - 크롤링 로그 기록으로 추적 가능

---

## 개발 메모

### 유용한 명령어
```bash
# 가상환경 활성화
source venv/bin/activate  # Mac/Linux
venv\Scripts\activate     # Windows

# 크롤링 실행
python -m crawling.main

# Supabase 테이블 확인
# Supabase Dashboard > Table Editor
```

### 참고 자료
- [Supabase 공식 문서](https://supabase.com/docs)
- [big.js GitHub](https://github.com/MikeMcl/big.js)
- [Selenium 문서](https://selenium-python.readthedocs.io/)

---

**최종 업데이트**: 2026.02.11
