# 🔍 엣지 케이스 및 오류 가능성 분석

## 4단계 대출 계산 알고리즘 - 잠재적 문제점 및 개선 필요 사항

---

## 1. 수학적 정밀도 관련 이슈

### 문제 1: 부동소수점 오차 누적
**발생 가능 상황:**
- 600개월(50년)과 같이 긴 상환 기간에서 반복 계산 시
- 원금균등 방식에서 월별 이자를 누적할 때

**현재 해결책:**
- `big.js` 라이브러리 사용
- 소수점 4자리까지 정밀도 설정 (DECIMAL(15,4) 수준)

**잠재적 문제:**
- 600개월 × 4자리 정밀도 = 최대 0.0001원 × 600 = 0.06원 오차
- 실무적으로는 무시 가능하나, 금융 감독 기준에서는 1원 단위까지 정확해야 할 수 있음

**개선 제안:**
```typescript
// 최종 결과를 정수로 반올림하여 오차 제거
return Math.round(result.toNumber());
```

---

## 2. 금리 관련 엣지 케이스

### 문제 2-1: 무이자(0%) 대출
**발생 가능 상황:**
- 학자금 대출, 특별 우대 상품
- 모든 우대금리를 합산했을 때 0%가 되는 경우

**현재 처리:**
```typescript
if (monthlyRate.eq(0)) {
  return principal.div(months);
}
```

**잠재적 문제:**
- 중도상환 수수료 계산 시 이자가 0이므로 수수료만 부담
- BEP 계산 시 `monthlySavings`가 0 또는 음수일 수 있음

**테스트 필요:**
- [ ] 0% 금리 대출의 시뮬레이션 결과 검증
- [ ] BEP가 -1로 정상 반환되는지 확인

### 문제 2-2: 음수 금리
**발생 가능 상황:**
- 우대금리 합산 시 `기본금리 + 가산금리 - 우대금리 < 0`

**현재 처리:**
```typescript
if (newRate.lt(0)) {
  newRate = Big(0);
}
```

**잠재적 문제:**
- 논리적으로 맞지만, 실제로는 발생하지 않아야 함
- 사용자 입력 검증이 필요

**개선 제안:**
- 프론트엔드에서 사전 검증 추가
- 우대금리 입력 시 "최대 (기본금리 + 가산금리)까지만 가능" 안내

### 문제 2-3: 비현실적으로 높은 금리
**발생 가능 상황:**
- 사용자가 실수로 300% 입력 (30% 의도)
- 법정 최고 금리(20%) 초과

**현재 처리:**
- `FinanceConfig.MAX_INTEREST_RATE = 30%`로 상한 설정
- `Validators.isValidInterestRate()` 검증 함수 제공

**잠재적 문제:**
- API 레벨에서 검증하지 않으면 통과될 수 있음
- 크롤링 데이터도 검증 필요

**개선 제안:**
```typescript
// API 엔드포인트에서 검증
if (!Validators.isValidInterestRate(currentDebt.interestRate)) {
  throw new Error('금리는 0%~30% 사이여야 합니다.');
}
```

---

## 3. 상환 기간 관련 엣지 케이스

### 문제 3-1: 잔여 기간이 0개월
**발생 가능 상황:**
- 마지막 달에 대환대출 시뮬레이션 시도
- `remainingMonths = 0`

**현재 처리:**
- 없음 (오류 발생 가능)

**잠재적 문제:**
- 나눗셈 오류: `principal.div(0)`
- 의미 없는 시뮬레이션

**개선 제안:**
```typescript
if (currentDebt.remainingMonths <= 0) {
  throw new Error('잔여 상환 기간이 없습니다.');
}
```

### 문제 3-2: 잔여 기간 > 전체 기간
**발생 가능 상황:**
- 사용자 입력 오류
- `remainingMonths > totalMonths`

**현재 처리:**
- 없음 (논리적 오류 발생)

**잠재적 문제:**
- 중도상환 수수료 계산 시 `elapsedMonths < 0`
- 비정상적인 결과

**개선 제안:**
```typescript
if (currentDebt.remainingMonths > currentDebt.totalMonths) {
  throw new Error('잔여 기간이 전체 기간보다 클 수 없습니다.');
}
```

---

## 4. 중도상환 수수료 관련 엣지 케이스

### 문제 4-1: 수수료 면제 기간 = 0
**발생 가능 상황:**
- 특정 상품에서 중도상환 수수료가 없는 경우

**현재 처리:**
```typescript
if (elapsedMonths >= feeWaiverMonths) {
  return Big(0);
}
```

**잠재적 문제:**
- `feeWaiverMonths = 0`이면 항상 수수료 0원
- 논리적으로 맞지만, DB에서 NULL 처리 필요

**개선 제안:**
- DB 스키마: `DEFAULT 36` 유지
- 수수료 없는 상품은 `feeWaiverMonths = 0` 명시

### 문제 4-2: 수수료율이 비정상적으로 높음
**발생 가능 상황:**
- 크롤링 오류로 5% 이상 수수료율 입력

**현재 처리:**
- DB CHECK 제약조건: `early_repay_fee_rate <= 5`

**잠재적 문제:**
- 5% 수수료도 비현실적 (일반적으로 1~2%)

**개선 제안:**
- 프론트엔드에서 경고 표시
- "일반적인 수수료율(1.5%)보다 높습니다. 확인하세요."

---

## 5. 손익분기점(BEP) 계산 관련 이슈

### 문제 5-1: 월별 절감액이 0원 또는 음수
**발생 가능 상황:**
- 신규 금리가 현재 금리보다 높은 경우
- `monthlySavings <= 0`

**현재 처리:**
```typescript
if (monthlySavings.gt(0)) {
  const bepMonths = totalRefinanceCost.div(monthlySavings);
  breakEvenMonths = Math.ceil(bepMonths.toNumber());
}
```

**잠재적 문제:**
- `breakEvenMonths = -1`로 반환되지만, UI에서 해석 필요

**개선 제안:**
- 결과 타입에 `hasAdvantage: boolean` 필드 추가
- "대환대출 시 손해입니다" 명시적 표시

### 문제 5-2: BEP가 잔여 기간보다 긺
**발생 가능 상황:**
- 비용 대비 절감액이 적은 경우
- `breakEvenMonths > remainingMonths`

**현재 처리:**
- 추천 액션에서 "현재_유지"로 분류

**잠재적 문제:**
- 사용자가 왜 유지해야 하는지 이해 못 할 수 있음

**개선 제안:**
- 결과에 `reason` 필드 추가
- "손익분기점(48개월)이 잔여 기간(36개월)보다 길어 손해입니다."

---

## 6. 추천 액션 로직 개선 필요

### 문제 6-1: "수수료_면제_대기" 조건 모호
**현재 로직:**
```typescript
else if (earlyRepayFee.gt(0) && monthsUntilWaiver > 0 && monthsUntilWaiver <= 3) {
  recommendedAction = '수수료_면제_대기';
}
```

**잠재적 문제:**
- 3개월 기준이 임의적
- 수수료가 적을 때는 즉시 대환이 나을 수 있음

**개선 제안:**
```typescript
// 수수료 면제 대기 vs 즉시 대환 비교
const savingsIfWait = calculateSavingsIfWait(monthsUntilWaiver);
const savingsIfNow = netSavings;

if (savingsIfWait.gt(savingsIfNow)) {
  recommendedAction = '수수료_면제_대기';
}
```

### 문제 6-2: 여러 대출 상품 중 최적 선택
**발생 가능 상황:**
- 5개 은행 × 3개 상품 = 15개 선택지

**현재 처리:**
- `findBestRefinancingOption()` 함수로 순이익 기준 선택

**잠재적 문제:**
- 순이익만 고려하면 BEP가 긴 상품이 선택될 수 있음

**개선 제안:**
- 가중치 점수 시스템
  - 순이익 40%
  - BEP 30%
  - 월별 절감액 20%
  - 신뢰도(은행 신용등급) 10%

---

## 7. 데이터 타입 및 범위 검증

### 문제 7-1: 큰 금액의 오버플로우
**발생 가능 상황:**
- 10억원 이상 대출
- `Big` 타입은 안전하지만, 최종 `number` 변환 시 문제 가능

**현재 처리:**
- `Big.toNumber()` 사용

**잠재적 문제:**
- JavaScript `number`는 안전 정수: ±2^53 (약 9천조)
- 대출 금액으로는 문제 없지만, 누적 계산 시 주의 필요

**개선 제안:**
- 5억원 초과 대출은 경고 표시
- 결과를 `string`으로도 제공하여 UI에서 big.js로 처리

### 문제 7-2: NULL 처리
**발생 가능 상황:**
- 크롤링 실패로 일부 필드가 NULL

**현재 처리:**
- DB DEFAULT 값으로 대체

**잠재적 문제:**
- DEFAULT 값이 부적절할 수 있음

**개선 제안:**
- API에서 NULL 체크 후 에러 반환
- "해당 상품 정보가 불완전합니다" 표시

---

## 8. 성능 및 최적화

### 문제 8-1: 월별 스케줄 계산 비용
**발생 가능 상황:**
- 600개월 × 15개 상품 = 9,000번 반복 계산

**현재 처리:**
- 매번 전체 스케줄 생성

**잠재적 문제:**
- 프론트엔드에서 느려질 수 있음

**개선 제안:**
- 스케줄은 필요 시에만 생성 (lazy evaluation)
- 총 이자만 필요하면 스케줄 생성 생략

```typescript
// 최적화: 스케줄 없이 총 이자만 계산
calculateTotalInterestFast(principal, rate, months);
```

---

## 9. 보안 및 입력 검증

### 문제 9-1: SQL Injection (Supabase RLS)
**현재 처리:**
- Supabase 자체 보안

**잠재적 문제:**
- RLS 설정 오류 시 데이터 노출

**개선 제안:**
- Supabase RLS 정책 검토
- API 레벨에서도 권한 검증

### 문제 9-2: XSS 공격
**발생 가능 상황:**
- 사용자 입력 은행명, 상품명에 스크립트 삽입

**현재 처리:**
- Next.js 기본 보호

**개선 제안:**
- 입력값 sanitization
- 특수문자 제거 또는 이스케이프

---

## 10. 사용자 경험(UX) 개선 필요

### 문제 10-1: 오류 메시지 부족
**현재 상태:**
- `throw new Error()` 만 사용

**개선 제안:**
- 사용자 친화적 메시지
  - ❌ "Invalid interest rate"
  - ✅ "금리는 0%~30% 사이로 입력해주세요."

### 문제 10-2: 로딩 상태 표시 부족
**발생 가능 상황:**
- 15개 상품 비교 시 1~2초 소요

**개선 제안:**
- 프로그레스 바 표시
- "최적 상품 분석 중... (5/15)"

---

## 📝 테스트 시나리오 체크리스트

### 정상 케이스
- [ ] 원리금균등 3% → 2% 대환 (일반적 케이스)
- [ ] 원금균등 5% → 3% 대환
- [ ] 급여이체 우대 적용

### 경계값 테스트
- [ ] 금리 0% (무이자)
- [ ] 금리 30% (최고)
- [ ] 잔여 기간 1개월
- [ ] 잔여 기간 600개월

### 오류 케이스
- [ ] 금리 음수
- [ ] 금리 100%
- [ ] 잔여 기간 0
- [ ] 잔여 기간 > 전체 기간
- [ ] 대출 금액 0원
- [ ] 대출 금액 100억원

### 비즈니스 로직 테스트
- [ ] BEP가 잔여 기간보다 긴 경우
- [ ] 수수료 면제까지 1개월 남은 경우
- [ ] 신규 금리가 더 높은 경우 (손해)

---

## ✅ 권장 개선 우선순위

### 🔴 High Priority (필수)
1. 입력값 검증 강화 (금리, 기간, 금액 범위)
2. NULL 처리 로직 추가
3. 잔여 기간 0 또는 음수 방어 코드

### 🟡 Medium Priority (권장)
4. BEP 로직 개선 (수수료 면제 대기 고려)
5. 오류 메시지 사용자 친화적으로 개선
6. 성능 최적화 (스케줄 lazy evaluation)

### 🟢 Low Priority (선택)
7. 가중치 기반 상품 추천
8. 결과 타입에 추가 필드 (reason, hasAdvantage 등)

---

**작성일**: 2026.02.11  
**작성자**: AI (Claude) + 개발자 검토 필요
